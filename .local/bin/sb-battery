#!/bin/sh

full="#"
unknown="?"
charging="+"
discharging="-"
notcharging="."

batterylevel() {
    batterycapacity=$1
    batterylevels=" â–â–‚â–ƒâ–„â–…â–†â–‡â–ˆ"

    batterylevelposition=$(((${#batterylevels}-1)*batterycapacity/100))

    echo ${batterylevels:$batterylevelposition:1}
}

warning() {
	file=/tmp/sb-battery__warning-file
	now=$(date +%s)
	lastwarning=0

	if [ -f "$file" ]; then
		lastwarning=$(cat "$file")
	fi

	if [ $((now-lastwarning)) -ge 60 ]; then
		notify-send -u critical -c warning -t 250 "ðŸª« WARNING: Battery is too low." \
			&& sleep '0.5s' \
			&& notify-send -u critical -c warning -t 250 "ðŸª« WARNING: Battery is too low." \
			&& sleep '0.5s' \
			&& notify-send -u critical -c warning -t 58750 "ðŸª« WARNING: Battery is too low." &
		printf "$now" > "$file"
	fi
}

for battery in /sys/class/power_supply/BAT?*; do
	[ -n "${capacity+x}" ] && continue

	capacity=$(cat "$battery/capacity")

    [ $capacity -gt 100 ] && capacity=100
    [ $capacity -lt 0 ] && capacity=0

	case "$(cat "$battery/status")" in
		"Full")			status="$full"			;;
		"Unknown")		status="$unknown"		;;
		"Charging")		status="$charging"		;;
		"Discharging")	status="$discharging"	;;
		"Not charging")	status="$notcharging"	;;
	esac

	[ "$status" = "$full"			] && [ $capacity -ge 99 ] && continue
	[ "$status" = "$unknown"		] && [ $capacity -ge 99 ] && continue
	[ "$status" = "$charging"		] && [ $capacity -ge 99 ] && continue
	[ "$status" = "$unknown"		] && [ $capacity -le 25 ] && status="!" && warning
	[ "$status" = "$discharging"	] && [ $capacity -le 25 ] && status="!" && warning
	[ "$status" = "$notcharging"	] && [ $capacity -le 25 ] && status="!" && warning

	capacitytext=$(printf " %.0s%s" {0..$((capacity/10))} "$capacity")

	echo "$status$capacitytext% $(batterylevel "$capacity")"
done && exit 0

